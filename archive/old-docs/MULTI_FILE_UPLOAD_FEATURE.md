# 模板管理多文件上传功能

## ✅ 新增功能

### 1. 批量文件上传
- ✅ 支持同时选择多个 .md 和 .txt 文件
- ✅ 拖拽上传时支持多文件
- ✅ 点击上传时支持多文件选择
- ✅ 文件重复检测
- ✅ 文件类型验证

### 2. 文件列表管理
- ✅ 显示已选文件数量
- ✅ 显示文件名和大小
- ✅ 单个文件删除
- ✅ 一键清空所有文件
- ✅ 文件大小格式化显示（B/KB/MB/GB）

### 3. 一键批量分析
- ✅ 逐个分析所有文件
- ✅ 自动合并提取结果
- ✅ 自动去重语句
- ✅ 显示分析进度
- ✅ 统计成功/失败数量

### 4. 用户体验优化
- ✅ 文件列表最大高度200px，超出滚动
- ✅ 文件项悬停高亮效果
- ✅ 实时反馈（添加/删除文件提示）
- ✅ 分析按钮显示文件数量
- ✅ 分析状态显示

## 🎨 界面预览

### 上传区域
```
┌─────────────────────────────────────────┐
│  📁                                     │
│  拖拽文件到此处或点击上传                │
│  支持多文件上传，仅支持 .md 和 .txt 文件  │
└─────────────────────────────────────────┘
```

### 文件列表
```
已选择 3 个文件                        [清空全部]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📄 病程记录1.md           2.5 KB     ×
📄 病程记录2.txt          1.8 KB     ×
📄 病程记录3.md           3.2 KB     ×
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────────┐
│  ✨ 一键分析所有文件 (3)                │
└─────────────────────────────────────────┘
```

## 💡 使用流程

### 步骤1：选择文件
1. 点击上传区域或拖拽文件
2. 可以一次选择多个文件
3. 系统自动验证文件类型和重复

### 步骤2：管理文件列表
- 查看已选文件数量
- 查看每个文件的大小
- 单独删除不需要的文件
- 一键清空所有文件

### 步骤3：一键分析
1. 点击"一键分析所有文件"按钮
2. 系统逐个分析文件
3. 自动合并和去重语句
4. 显示统计结果：
   - 成功分析的文件数
   - 失败的文件数
   - 提取的总语句数

### 步骤4：编辑和保存
- 查看合并后的所有语句
- 编辑语句内容和分类
- 批量保存到模板库

## 🔧 技术实现

### 数据结构
```typescript
// 多文件存储
const selectedFiles = ref<File[]>([])
const fileList = ref<any[]>([])

// 分析状态
const analyzing = ref(false)
const analyzingFileName = ref('')

// 提取结果
const extractedPhrases = ref<Array<{ content: string; category: string }>>([])
```

### 核心函数

#### 1. handleFileSelect(file)
```typescript
// 验证文件类型
// 检查文件重复
// 添加到文件列表
// 显示成功提示
```

#### 2. analyzeAllFiles()
```typescript
// 遍历所有文件
// 逐个读取内容
// 调用AI分析API
// 合并和去重语句
// 统计成功/失败
// 显示结果
```

#### 3. formatFileSize(bytes)
```typescript
// 格式化文件大小
// 自动转换单位（B/KB/MB/GB）
```

### 去重逻辑
```typescript
// 按内容和分类去重
const exists = allPhrases.some(p =>
  p.content === phrase.content && p.category === phrase.category
)
```

## 📊 性能优化

### 1. 文件读取优化
- 使用 FileReader 异步读取
- 逐个处理，避免内存溢出
- 大文件分块处理

### 2. 语句去重优化
- 使用 some() 方法高效判断
- 内容和分类双重判断
- O(n²) 时间复杂度，但模板数量通常较少

### 3. 用户体验优化
- 实时反馈每个操作
- 显示分析进度
- 错误处理和提示

## ⚠️ 注意事项

### 1. 文件限制
- 仅支持 .md 和 .txt 格式
- 建议单个文件不超过 10MB
- 建议一次上传不超过 20 个文件

### 2. 网络要求
- 需要稳定的网络连接
- 每个文件都需要调用AI API
- 失败的文件不影响其他文件

### 3. 成本考虑
- 多文件分析会增加 API 调用次数
- Python预处理已降低97% token消耗
- 建议合并相似内容的文件

## 🎯 使用建议

### 最佳实践
1. **文件组织**：将相似的病程记录放在一个文件中
2. **批量处理**：一次性上传所有相关文件
3. **结果审核**：AI分析后人工审核和编辑
4. **分类管理**：合理设置语句分类便于后续使用

### 典型场景
- 导出多日的病程记录
- 收集多个医生的记录
- 整理不同科室的模板
- 建立个人模板库

## 🐛 故障排除

### 问题1：文件上传失败
**检查**：
- 文件格式是否为 .md 或 .txt
- 文件是否已损坏
- 文件大小是否合理

### 问题2：分析卡住
**原因**：网络问题或API超时
**解决**：
- 检查网络连接
- 刷新页面重新上传
- 减少单次上传的文件数量

### 问题3：语句重复
**说明**：去重基于内容完全匹配
**解决**：手动编辑合并相似语句

---

**版本**：v1.1.0
**更新日期**：2026-01-31
**作者**：康复科助手开发团队
