# åº·å¤ç§‘åŠ©æ‰‹å®Œæ•´å®æ–½è®¡åˆ’

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**ç›®æ ‡:** ä¸ºä¸­åŒ»é™¢åº·å¤ç§‘å¼€å‘ä¸€æ¬¾Pythonæ¡Œé¢åº”ç”¨ï¼Œå®ç°AIè¾…åŠ©ç—…ç¨‹è®°å½•ç”Ÿæˆã€æ™ºèƒ½æé†’ç³»ç»Ÿã€æ‚£è€…ç®¡ç†å’ŒçŸ¥è¯†åº“åŠŸèƒ½

**æ¶æ„:** é‡‡ç”¨CustomTkinteræ„å»ºiOSé£æ ¼GUIï¼ŒSQLAlchemy ORMç®¡ç†SQLiteæ•°æ®åº“ï¼Œé›†æˆå¤šä¸ªAIæœåŠ¡APIï¼ˆé­”æ­/DeepSeek/Kimiï¼‰ï¼Œä½¿ç”¨ChromaDBå®ç°å‘é‡åŒ–çŸ¥è¯†åº“ï¼Œç¡…åŸºæµåŠ¨APIæä¾›åµŒå…¥æœåŠ¡

**æŠ€æœ¯æ ˆ:** CustomTkinter, SQLAlchemy, SQLite, ChromaDB, PyPDF, python-docx, requests, OpenAI-compatible APIs

---

## ç›®å½•

1. [é¡¹ç›®åˆå§‹åŒ–](#task-1-é¡¹ç›®åˆå§‹åŒ–)
2. [æ•°æ®åº“å±‚](#task-2-æ•°æ®åº“å±‚)
3. [AIæœåŠ¡å±‚](#task-3-aiæœåŠ¡å±‚)
4. [çŸ¥è¯†åº“ç³»ç»Ÿ](#task-4-çŸ¥è¯†åº“ç³»ç»Ÿ)
5. [æ ¸å¿ƒä¸šåŠ¡æ¨¡å—](#task-5-æ ¸å¿ƒä¸šåŠ¡æ¨¡å—)
6. [GUIç•Œé¢å±‚](#task-6-guiç•Œé¢å±‚)
7. [é›†æˆæµ‹è¯•](#task-7-é›†æˆæµ‹è¯•)

---

## Task 1: é¡¹ç›®åˆå§‹åŒ–

**Files:**
- Create: `requirements.txt`
- Create: `config.json`
- Create: `.env.example`
- Create: `main.py`
- Create: `README.md`

**Step 1: Write requirements.txt**

```txt
# GUIæ¡†æ¶
customtkinter>=5.2.0

# æ•°æ®åº“
sqlalchemy>=2.0.0

# AIå’Œå‘é‡æ•°æ®åº“
requests>=2.31.0
chromadb>=0.4.0

# æ–‡æ¡£è§£æ
pypdf>=3.0.0
python-docx>=0.8.11
ebooklib>=0.18
Pillow>=10.0.0

# å·¥å…·åº“
python-dateutil>=2.8.0
python-dotenv>=1.0.0
```

**Step 2: Write config.json**

```json
{
  "app": {
    "name": "åº·å¤ç§‘åŠ©æ‰‹",
    "version": "1.0.0",
    "database_path": "./rehab_assistant.db"
  },
  "siliconflow": {
    "api_key": "sk-tweswtuyrbzxxjiziprqrqchpkiwyxapctgaqutocucsptqx",
    "embedding_model": "BAAI/bge-large-zh-v1.5",
    "base_url": "https://api.siliconflow.cn/v1"
  },
  "ai_services": {
    "default": "modelscope",
    "modelscope": {
      "api_key": "",
      "model": "Qwen2.5-72B-Instruct",
      "base_url": "https://api.modelscope.cn/v1"
    },
    "deepseek": {
      "api_key": "",
      "model": "deepseek-chat",
      "base_url": "https://api.deepseek.com/v1"
    },
    "kimi": {
      "api_key": "",
      "model": "moonshot-v1-8k",
      "base_url": "https://api.moonshot.cn/v1"
    }
  },
  "knowledge_base": {
    "chroma_path": "./knowledge_base/data",
    "file_path": "./knowledge_base/files",
    "chunk_size": 800,
    "chunk_overlap": 100,
    "top_k_results": 5
  },
  "doctors": {
    "resident": "äºå‹è¾¾",
    "attending": "éƒ½å‰é¦™",
    "chief": "è½¦æ°¸ç”Ÿ"
  }
}
```

**Step 3: Write .env.example**

```env
# AIæœåŠ¡APIå¯†é’¥
MODELSCOPE_API_KEY=your_modelscope_api_key_here
DEEPSEEK_API_KEY=your_deepseek_api_key_here
KIMI_API_KEY=your_kimi_api_key_here

# ç¡…åŸºæµåŠ¨APIå¯†é’¥
SILICONFLOW_API_KEY=sk-tweswtuyrbzxxjiziprqrqchpkiwyxapctgaqutocucsptqx
```

**Step 4: Write main.py (åŸºç¡€å…¥å£)**

```python
"""
åº·å¤ç§‘åŠ©æ‰‹ - ä¸»å…¥å£
"""
import customtkinter as ctk
from pathlib import Path

def main():
    # é…ç½®CustomTkinter
    ctk.set_appearance_mode("Light")
    ctk.set_default_color_theme("blue")

    # åˆ›å»ºä¸»çª—å£
    app = ctk.CTk()
    app.geometry("1400x900")
    app.title("åº·å¤ç§‘åŠ©æ‰‹")

    # TODO: åŠ è½½é…ç½®
    # TODO: åˆå§‹åŒ–æ•°æ®åº“
    # TODO: åˆå§‹åŒ–çŸ¥è¯†åº“
    # TODO: åˆ›å»ºä¸»ç•Œé¢

    app.mainloop()

if __name__ == "__main__":
    main()
```

**Step 5: Commit**

```bash
git add requirements.txt config.json .env.example main.py
git commit -m "feat: initialize project structure with dependencies"
```

---

## Task 2: æ•°æ®åº“å±‚

### Task 2.1: åˆ›å»ºæ•°æ®æ¨¡å‹

**Files:**
- Create: `database/__init__.py`
- Create: `database/models.py`
- Create: `database/db_manager.py`

**Step 1: Write database/models.py**

```python
"""
SQLAlchemyæ•°æ®æ¨¡å‹å®šä¹‰
"""
from datetime import datetime
from typing import Optional
from sqlalchemy import String, Integer, Text, Boolean, Date, ForeignKey
from sqlalchemy.orm import Mapped, mapped_column, relationship
from sqlalchemy.types import LargeBinary
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class Patient(Base):
    """æ‚£è€…ä¿¡æ¯è¡¨"""
    __tablename__ = 'patients'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    hospital_number: Mapped[str] = mapped_column(String(50), unique=True, nullable=False)
    name: Mapped[Optional[str]] = mapped_column(String(50))
    gender: Mapped[Optional[str]] = mapped_column(String(10))
    age: Mapped[Optional[int]] = mapped_column(Integer)
    admission_date: Mapped[datetime] = mapped_column(Date, nullable=False)
    discharge_date: Mapped[Optional[datetime]] = mapped_column(Date)
    chief_complaint: Mapped[Optional[str]] = mapped_column(Text)
    diagnosis: Mapped[Optional[str]] = mapped_column(Text)
    past_history: Mapped[Optional[str]] = mapped_column(Text)
    allergy_history: Mapped[Optional[str]] = mapped_column(Text)
    specialist_exam: Mapped[Optional[str]] = mapped_column(Text)
    initial_note: Mapped[Optional[str]] = mapped_column(Text)
    created_at: Mapped[datetime] = mapped_column(Date, default=datetime.now)
    updated_at: Mapped[datetime] = mapped_column(Date, default=datetime.now, onupdate=datetime.now)

    # å…³ç³»
    progress_notes: Mapped[list["ProgressNote"]] = relationship("ProgressNote", back_populates="patient", cascade="all, delete-orphan")
    reminders: Mapped[list["Reminder"]] = relationship("Reminder", back_populates="patient", cascade="all, delete-orphan")

    def __repr__(self):
        return f"<Patient(hospital_number={self.hospital_number}, name={self.name})>"


class ProgressNote(Base):
    """ç—…ç¨‹è®°å½•è¡¨"""
    __tablename__ = 'progress_notes'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    patient_id: Mapped[int] = mapped_column(Integer, ForeignKey('patients.id'), nullable=False)
    hospital_number: Mapped[str] = mapped_column(String(50), nullable=False)
    record_date: Mapped[datetime] = mapped_column(Date, nullable=False)
    day_number: Mapped[int] = mapped_column(Integer, nullable=False)
    record_type: Mapped[str] = mapped_column(String(50), nullable=False)
    daily_condition: Mapped[Optional[str]] = mapped_column(Text)
    generated_content: Mapped[Optional[str]] = mapped_column(Text)
    is_edited: Mapped[bool] = mapped_column(Boolean, default=False)
    created_at: Mapped[datetime] = mapped_column(Date, default=datetime.now)

    # å…³ç³»
    patient: Mapped["Patient"] = relationship("Patient", back_populates="progress_notes")

    def __repr__(self):
        return f"<ProgressNote(date={self.record_date}, type={self.record_type})>"


class Reminder(Base):
    """æé†’è¡¨"""
    __tablename__ = 'reminders'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    patient_id: Mapped[int] = mapped_column(Integer, ForeignKey('patients.id'), nullable=False)
    hospital_number: Mapped[str] = mapped_column(String(50), nullable=False)
    reminder_type: Mapped[str] = mapped_column(String(50), nullable=False)
    reminder_date: Mapped[datetime] = mapped_column(Date, nullable=False)
    day_number: Mapped[Optional[int]] = mapped_column(Integer)
    description: Mapped[str] = mapped_column(Text, nullable=False)
    priority: Mapped[str] = mapped_column(String(20), nullable=False)  # ç´§æ€¥/é«˜/ä¸­/ä½
    is_completed: Mapped[bool] = mapped_column(Boolean, default=False)
    completed_at: Mapped[Optional[datetime]] = mapped_column(Date)
    created_at: Mapped[datetime] = mapped_column(Date, default=datetime.now)

    # å…³ç³»
    patient: Mapped["Patient"] = relationship("Patient", back_populates="reminders")

    def __repr__(self):
        return f"<Reminder(type={self.reminder_type}, date={self.reminder_date})>"


class Template(Base):
    """æ¨¡æ¿è¡¨"""
    __tablename__ = 'templates'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    category: Mapped[str] = mapped_column(String(50), nullable=False)
    template_name: Mapped[str] = mapped_column(String(100), nullable=False)
    content: Mapped[str] = mapped_column(Text, nullable=False)
    is_system: Mapped[bool] = mapped_column(Boolean, default=False)
    usage_count: Mapped[int] = mapped_column(Integer, default=0)
    created_at: Mapped[datetime] = mapped_column(Date, default=datetime.now)

    def __repr__(self):
        return f"<Template(name={self.template_name}, category={self.category})>"


class Doctor(Base):
    """åŒ»å¸ˆè¡¨"""
    __tablename__ = 'doctors'

    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    doctor_name: Mapped[str] = mapped_column(String(50), unique=True, nullable=False)
    roles: Mapped[str] = mapped_column(String(200), nullable=False)  # é€—å·åˆ†éš”
    default_roles: Mapped[str] = mapped_column(String(200), nullable=False)  # é€—å·åˆ†éš”
    created_at: Mapped[datetime] = mapped_column(Date, default=datetime.now)

    def __repr__(self):
        return f"<Doctor(name={self.doctor_name}, roles={self.roles})>"
```

**Step 2: Write database/db_manager.py**

```python
"""
æ•°æ®åº“ç®¡ç†å™¨
"""
from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker
from pathlib import Path
from typing import Optional
import json

from database.models import Base, Patient, ProgressNote, Reminder, Template, Doctor


class DBManager:
    """æ•°æ®åº“ç®¡ç†å™¨"""

    def __init__(self, db_path: str = "./rehab_assistant.db"):
        """åˆå§‹åŒ–æ•°æ®åº“è¿æ¥"""
        self.engine = create_engine(f'sqlite:///{db_path}', echo=False)
        self.SessionLocal = sessionmaker(bind=self.engine)
        self.create_tables()

    def create_tables(self):
        """åˆ›å»ºæ‰€æœ‰è¡¨"""
        Base.metadata.create_all(self.engine)

    def get_session(self) -> Session:
        """è·å–æ•°æ®åº“ä¼šè¯"""
        return self.SessionLocal()

    # æ‚£è€…ç›¸å…³æ“ä½œ
    def add_patient(self, patient_data: dict) -> int:
        """æ·»åŠ æ‚£è€…ï¼Œè¿”å›æ‚£è€…ID"""
        with self.get_session() as session:
            patient = Patient(**patient_data)
            session.add(patient)
            session.commit()
            session.refresh(patient)
            return patient.id

    def get_patient_by_hospital_number(self, hospital_number: str) -> Optional[Patient]:
        """æ ¹æ®ä½é™¢å·è·å–æ‚£è€…"""
        with self.get_session() as session:
            return session.query(Patient).filter(
                Patient.hospital_number == hospital_number
            ).first()

    def get_all_patients(self, include_discharged: bool = False) -> list[Patient]:
        """è·å–æ‰€æœ‰æ‚£è€…"""
        with self.get_session() as session:
            query = session.query(Patient)
            if not include_discharged:
                query = query.filter(Patient.discharge_date.is_(None))
            return query.all()

    def update_patient(self, hospital_number: str, update_data: dict) -> bool:
        """æ›´æ–°æ‚£è€…ä¿¡æ¯"""
        with self.get_session() as session:
            patient = session.query(Patient).filter(
                Patient.hospital_number == hospital_number
            ).first()
            if patient:
                for key, value in update_data.items():
                    setattr(patient, key, value)
                session.commit()
                return True
            return False

    # ç—…ç¨‹è®°å½•ç›¸å…³æ“ä½œ
    def add_progress_note(self, note_data: dict) -> int:
        """æ·»åŠ ç—…ç¨‹è®°å½•"""
        with self.get_session() as session:
            note = ProgressNote(**note_data)
            session.add(note)
            session.commit()
            session.refresh(note)
            return note.id

    def get_patient_notes(self, patient_id: int, limit: int = 5) -> list[ProgressNote]:
        """è·å–æ‚£è€…çš„æœ€è¿‘ç—…ç¨‹è®°å½•"""
        with self.get_session() as session:
            return session.query(ProgressNote).filter(
                ProgressNote.patient_id == patient_id
            ).order_by(ProgressNote.record_date.desc()).limit(limit).all()

    # æé†’ç›¸å…³æ“ä½œ
    def add_reminder(self, reminder_data: dict) -> int:
        """æ·»åŠ æé†’"""
        with self.get_session() as session:
            reminder = Reminder(**reminder_data)
            session.add(reminder)
            session.commit()
            session.refresh(reminder)
            return reminder.id

    def get_today_reminders(self, priority_filter: str = None) -> list[Reminder]:
        """è·å–ä»Šæ—¥å¾…å®Œæˆæé†’"""
        from datetime import date
        with self.get_session() as session:
            query = session.query(Reminder).filter(
                Reminder.reminder_date == date.today(),
                Reminder.is_completed == False
            )
            if priority_filter:
                query = query.filter(Reminder.priority == priority_filter)
            return query.order_by(Reminder.priority.desc()).all()

    def mark_reminder_completed(self, reminder_id: int) -> bool:
        """æ ‡è®°æé†’ä¸ºå·²å®Œæˆ"""
        from datetime import date
        with self.get_session() as session:
            reminder = session.query(Reminder).filter(Reminder.id == reminder_id).first()
            if reminder:
                reminder.is_completed = True
                reminder.completed_at = date.today()
                session.commit()
                return True
            return False

    # æ¨¡æ¿ç›¸å…³æ“ä½œ
    def add_template(self, template_data: dict) -> int:
        """æ·»åŠ æ¨¡æ¿"""
        with self.get_session() as session:
            template = Template(**template_data)
            session.add(template)
            session.commit()
            session.refresh(template)
            return template.id

    def get_templates_by_category(self, category: str) -> list[Template]:
        """æŒ‰åˆ†ç±»è·å–æ¨¡æ¿"""
        with self.get_session() as session:
            return session.query(Template).filter(
                Template.category == category
            ).order_by(Template.usage_count.desc()).all()

    def increment_template_usage(self, template_id: int):
        """å¢åŠ æ¨¡æ¿ä½¿ç”¨æ¬¡æ•°"""
        with self.get_session() as session:
            template = session.query(Template).filter(Template.id == template_id).first()
            if template:
                template.usage_count += 1
                session.commit()
```

**Step 3: Write database/__init__.py**

```python
"""
æ•°æ®åº“æ¨¡å—åˆå§‹åŒ–
"""
from database.db_manager import DBManager
from database.models import Patient, ProgressNote, Reminder, Template, Doctor, Base

__all__ = [
    'DBManager',
    'Patient',
    'ProgressNote',
    'Reminder',
    'Template',
    'Doctor',
    'Base'
]
```

**Step 4: Commit**

```bash
git add database/
git commit -m "feat: implement database models and manager with SQLAlchemy"
```

---

## Task 3: AIæœåŠ¡å±‚

### Task 3.1: åˆ›å»ºAIæœåŠ¡æŠ½è±¡å±‚

**Files:**
- Create: `ai_services/__init__.py`
- Create: `ai_services/base_service.py`
- Create: `ai_services/modelscope_service.py`
- Create: `ai_services/deepseek_service.py`
- Create: `ai_services/kimi_service.py`
- Create: `ai_services/siliconflow_embedder.py`
- Create: `ai_services/service_manager.py`

**Step 1: Write ai_services/base_service.py**

```python
"""
AIæœåŠ¡æŠ½è±¡åŸºç±»
"""
from abc import ABC, abstractmethod
from typing import dict


class AIService(ABC):
    """AIæœåŠ¡æŠ½è±¡åŸºç±»"""

    def __init__(self, api_key: str, base_url: str, model: str):
        self.api_key = api_key
        self.base_url = base_url
        self.model = model

    @abstractmethod
    def extract_patient_info(self, initial_note: str) -> dict:
        """ä»é¦–æ¬¡ç—…ç¨‹è®°å½•æå–æ‚£è€…ä¿¡æ¯"""
        pass

    @abstractmethod
    def generate_progress_note(self, context: dict) -> str:
        """ç”Ÿæˆç—…ç¨‹è®°å½•"""
        pass

    @abstractmethod
    def generate_rehab_plan(self, patient_info: dict) -> dict:
        """ç”Ÿæˆåº·å¤è®¡åˆ’"""
        pass

    def _call_api(self, messages: list, temperature: float = 0.7) -> str:
        """è°ƒç”¨AI APIçš„é€šç”¨æ–¹æ³•ï¼ˆå­ç±»éœ€å®ç°ï¼‰"""
        pass
```

**Step 2: Write ai_services/modelscope_service.py**

```python
"""
é­”æ­AIæœåŠ¡å®ç°
"""
import requests
from ai_services.base_service import AIService


class ModelScopeService(AIService):
    """é­”æ­AIæœåŠ¡"""

    def __init__(self, api_key: str, model: str = "Qwen2.5-72B-Instruct"):
        super().__init__(
            api_key=api_key,
            base_url="https://api.modelscope.cn/v1",
            model=model
        )
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

    def _call_api(self, messages: list, temperature: float = 0.7) -> str:
        """è°ƒç”¨é­”æ­API"""
        try:
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                json={
                    "model": self.model,
                    "messages": messages,
                    "temperature": temperature
                },
                timeout=60
            )
            response.raise_for_status()
            result = response.json()
            return result["choices"][0]["message"]["content"]
        except Exception as e:
            raise Exception(f"é­”æ­APIè°ƒç”¨å¤±è´¥: {str(e)}")

    def extract_patient_info(self, initial_note: str) -> dict:
        """ä»é¦–æ¬¡ç—…ç¨‹è®°å½•æå–æ‚£è€…ä¿¡æ¯"""
        prompt = f"""ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç—…å†å½•å…¥åŠ©æ‰‹ã€‚è¯·ä»ä»¥ä¸‹é¦–æ¬¡ç—…ç¨‹è®°å½•ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯ï¼Œä»¥JSONæ ¼å¼è¿”å›ï¼š

é¦–æ¬¡ç—…ç¨‹è®°å½•ï¼š
{initial_note}

éœ€è¦æå–çš„å­—æ®µï¼š
- å§“å
- æ€§åˆ«
- å¹´é¾„
- å…¥é™¢æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
- ä¸»è¯‰
- è¯Šæ–­
- æ—¢å¾€å²ï¼ˆå¦‚æœ‰ï¼‰
- è¿‡æ•å²ï¼ˆå¦‚æœ‰ï¼‰

è¯·åªè¿”å›JSONï¼Œä¸è¦å…¶ä»–å†…å®¹ã€‚"""

        messages = [
            {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šçš„åŒ»ç–—ä¿¡æ¯æå–åŠ©æ‰‹ã€‚"},
            {"role": "user", "content": prompt}
        ]

        response = self._call_api(messages, temperature=0.3)
        # TODO: æ·»åŠ JSONè§£æå’Œé”™è¯¯å¤„ç†
        return response

    def generate_progress_note(self, context: dict) -> str:
        """ç”Ÿæˆç—…ç¨‹è®°å½•"""
        prompt = f"""ä½ æ˜¯ä¸€ä½ä¸­åŒ»é™¢åº·å¤ç§‘çš„ä¸“ä¸šåŒ»å¸ˆã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä»Šæ—¥ç—…ç¨‹è®°å½•ï¼š

ã€æ‚£è€…åŸºæœ¬ä¿¡æ¯ã€‘
å§“åï¼š{context['name']}
æ€§åˆ«ï¼š{context['gender']}
å¹´é¾„ï¼š{context['age']}
è¯Šæ–­ï¼š{context['diagnosis']}
ä½é™¢ç¬¬{context['day_number']}å¤©

ã€é¦–æ¬¡ç—…ç¨‹è®°å½•ã€‘
{context['initial_note']}

ã€æœ€è¿‘2æ¬¡ç—…ç¨‹è®°å½•ã€‘
{context.get('recent_notes_1', 'æ— ')}
{context.get('recent_notes_2', 'æ— ')}

ã€ä»Šæ—¥æƒ…å†µã€‘
{context['daily_condition']}

ã€è®°å½•ç±»å‹ã€‘
{context['record_type']}

è¦æ±‚ï¼š
1. è¯­è¨€é£æ ¼ç¬¦åˆä¸­åŒ»ç—…å†è§„èŒƒ
2. æ ¹æ®è®°å½•ç±»å‹è°ƒæ•´å†…å®¹è¯¦ç•¥ï¼ˆä½é™¢åŒ»å¸ˆè¯¦ç»†ï¼Œä¸»æ²»/ä¸»ä»»åŒ»å¸ˆç®€æ´ï¼‰
3. ä¸»è¯‰éƒ¨åˆ†ç»“åˆä»Šæ—¥æƒ…å†µæ›´æ–°
4. æŸ¥ä½“éƒ¨åˆ†æŒ‰å®é™…æƒ…å†µæè¿°ï¼Œå¦‚æ— ç‰¹æ®Šå˜åŒ–å¯å†™"æŸ¥ä½“åŒå‰"
5. åˆ†æå’Œå¤„ç†æ„è§è¦ä½“ç°ä¸­åŒ»ç‰¹è‰²å’Œåº·å¤ä¸“ä¸šç‰¹ç‚¹
6. å­—æ•°æ§åˆ¶åœ¨200-400å­—

è¯·ç›´æ¥è¾“å‡ºç—…ç¨‹è®°å½•å†…å®¹ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
YYYY-MM-DD HH:MM è®°å½•ç±»å‹
ä¸»è¯‰ï¼š...
æŸ¥ä½“ï¼š...
åˆ†æï¼š...
å¤„ç†ï¼š...
ç­¾åï¼š..."""

        messages = [
            {"role": "system", "content": "ä½ æ˜¯ä¸­åŒ»é™¢åº·å¤ç§‘çš„ä¸“ä¸šåŒ»å¸ˆã€‚"},
            {"role": "user", "content": prompt}
        ]

        return self._call_api(messages, temperature=0.7)

    def generate_rehab_plan(self, patient_info: dict) -> dict:
        """ç”Ÿæˆåº·å¤è®¡åˆ’"""
        prompt = f"""è¯·ä¸ºä»¥ä¸‹æ‚£è€…åˆ¶å®šåº·å¤è®¡åˆ’ï¼š

æ‚£è€…ä¿¡æ¯ï¼š
å§“åï¼š{patient_info['name']}
è¯Šæ–­ï¼š{patient_info['diagnosis']}
åŠŸèƒ½éšœç¢ï¼š{patient_info.get('dysfunction', 'æœªè¯¦ç»†æè¿°')}

è¯·ç”ŸæˆåŒ…æ‹¬ä»¥ä¸‹å†…å®¹çš„åº·å¤è®¡åˆ’ï¼š
1. åº·å¤ç›®æ ‡ï¼ˆçŸ­æœŸå’Œé•¿æœŸï¼‰
2. å¹²é¢„æªæ–½ï¼ˆè¿åŠ¨ç–—æ³•ã€ä½œä¸šæ²»ç–—ã€ç‰©ç†å› å­æ²»ç–—ç­‰ï¼‰
3. æ³¨æ„äº‹é¡¹

ä»¥JSONæ ¼å¼è¿”å›ã€‚"""

        messages = [
            {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šçš„åº·å¤æ²»ç–—å¸ˆã€‚"},
            {"role": "user", "content": prompt}
        ]

        response = self._call_api(messages, temperature=0.7)
        # TODO: æ·»åŠ JSONè§£æ
        return {"plan": response}
```

**Step 3: Write ai_services/deepseek_service.py**

```python
"""
DeepSeek AIæœåŠ¡å®ç°
"""
import requests
from ai_services.base_service import AIService


class DeepSeekService(AIService):
    """DeepSeek AIæœåŠ¡"""

    def __init__(self, api_key: str, model: str = "deepseek-chat"):
        super().__init__(
            api_key=api_key,
            base_url="https://api.deepseek.com/v1",
            model=model
        )
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

    def _call_api(self, messages: list, temperature: float = 0.7) -> str:
        """è°ƒç”¨DeepSeek API"""
        try:
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                json={
                    "model": self.model,
                    "messages": messages,
                    "temperature": temperature
                },
                timeout=60
            )
            response.raise_for_status()
            result = response.json()
            return result["choices"][0]["message"]["content"]
        except Exception as e:
            raise Exception(f"DeepSeek APIè°ƒç”¨å¤±è´¥: {str(e)}")

    # å¤ç”¨ç›¸åŒçš„æ¥å£å®ç°ï¼Œåªéœ€ä¿®æ”¹APIè°ƒç”¨éƒ¨åˆ†
    def extract_patient_info(self, initial_note: str) -> dict:
        """å®ç°ä¸ModelScopeServiceç›¸åŒçš„é€»è¾‘"""
        # TODO: å¤åˆ¶ModelScopeServiceçš„å®ç°
        pass

    def generate_progress_note(self, context: dict) -> str:
        """å®ç°ä¸ModelScopeServiceç›¸åŒçš„é€»è¾‘"""
        # TODO: å¤åˆ¶ModelScopeServiceçš„å®ç°
        pass

    def generate_rehab_plan(self, patient_info: dict) -> dict:
        """å®ç°ä¸ModelScopeServiceç›¸åŒçš„é€»è¾‘"""
        # TODO: å¤åˆ¶ModelScopeServiceçš„å®ç°
        pass
```

**Step 4: Write ai_services/kimi_service.py**

```python
"""
Kimi AIæœåŠ¡å®ç°
"""
import requests
from ai_services.base_service import AIService


class KimiService(AIService):
    """Kimi AIæœåŠ¡"""

    def __init__(self, api_key: str, model: str = "moonshot-v1-8k"):
        super().__init__(
            api_key=api_key,
            base_url="https://api.moonshot.cn/v1",
            model=model
        )
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

    def _call_api(self, messages: list, temperature: float = 0.7) -> str:
        """è°ƒç”¨Kimi API"""
        try:
            response = requests.post(
                f"{self.base_url}/chat/completions",
                headers=self.headers,
                json={
                    "model": self.model,
                    "messages": messages,
                    "temperature": temperature
                },
                timeout=60
            )
            response.raise_for_status()
            result = response.json()
            return result["choices"][0]["message"]["content"]
        except Exception as e:
            raise Exception(f"Kimi APIè°ƒç”¨å¤±è´¥: {str(e)}")

    # å®ç°ç›¸åŒçš„æ¥å£
    def extract_patient_info(self, initial_note: str) -> dict:
        pass

    def generate_progress_note(self, context: dict) -> str:
        pass

    def generate_rehab_plan(self, patient_info: dict) -> dict:
        pass
```

**Step 5: Write ai_services/siliconflow_embedder.py**

```python
"""
ç¡…åŸºæµåŠ¨åµŒå…¥æœåŠ¡
"""
import requests
from typing import list


class SiliconFlowEmbedder:
    """ç¡…åŸºæµåŠ¨åµŒå…¥æœåŠ¡"""

    def __init__(self, api_key: str):
        self.api_key = api_key
        self.base_url = "https://api.siliconflow.cn/v1"
        self.headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }

    def encode(self, texts: list[str]) -> list[list[float]]:
        """å°†æ–‡æœ¬å‘é‡åŒ–

        Args:
            texts: æ–‡æœ¬åˆ—è¡¨

        Returns:
            å‘é‡åˆ—è¡¨ï¼ˆæ¯ä¸ªå‘é‡1024ç»´ï¼‰
        """
        try:
            response = requests.post(
                f"{self.base_url}/embeddings",
                headers=self.headers,
                json={
                    "model": "BAAI/bge-large-zh-v1.5",
                    "input": texts,
                    "encoding_format": "float"
                },
                timeout=60
            )
            response.raise_for_status()
            result = response.json()

            # æå–å‘é‡
            embeddings = [item["embedding"] for item in result["data"]]
            return embeddings

        except Exception as e:
            raise Exception(f"ç¡…åŸºæµåŠ¨APIè°ƒç”¨å¤±è´¥: {str(e)}")
```

**Step 6: Write ai_services/service_manager.py**

```python
"""
AIæœåŠ¡ç®¡ç†å™¨
"""
from typing import Optional
from ai_services.base_service import AIService
from ai_services.modelscope_service import ModelScopeService
from ai_services.deepseek_service import DeepSeekService
from ai_services.kimi_service import KimiService
from ai_services.siliconflow_embedder import SiliconFlowEmbedder


class AIServiceManager:
    """AIæœåŠ¡ç®¡ç†å™¨"""

    def __init__(self, config: dict):
        """åˆå§‹åŒ–AIæœåŠ¡ç®¡ç†å™¨

        Args:
            config: é…ç½®å­—å…¸ï¼ŒåŒ…å«ai_servicesé…ç½®
        """
        self.services = {}
        self.default_service = None
        self.embedder = None

        # åˆå§‹åŒ–åµŒå…¥æœåŠ¡
        siliconflow_config = config.get("siliconflow", {})
        if siliconflow_config.get("api_key"):
            self.embedder = SiliconFlowEmbedder(
                api_key=siliconflow_config["api_key"]
            )

        # åˆå§‹åŒ–AIæœåŠ¡
        ai_config = config.get("ai_services", {})
        for provider, settings in ai_config.items():
            if provider == "default":
                continue

            if settings.get("api_key"):
                service_class = self._get_service_class(provider)
                self.services[provider] = service_class(
                    api_key=settings["api_key"],
                    model=settings.get("model")
                )

                if settings.get("is_default") or ai_config.get("default") == provider:
                    self.default_service = provider

    def get_service(self, provider: str = None) -> Optional[AIService]:
        """è·å–AIæœåŠ¡å®ä¾‹

        Args:
            provider: æœåŠ¡å•†åç§°ï¼Œé»˜è®¤ä½¿ç”¨defaultæœåŠ¡

        Returns:
            AIæœåŠ¡å®ä¾‹
        """
        if provider is None:
            provider = self.default_service

        return self.services.get(provider)

    def get_embedder(self) -> Optional[SiliconFlowEmbedder]:
        """è·å–åµŒå…¥æœåŠ¡"""
        return self.embedder

    def _get_service_class(self, provider: str):
        """æ ¹æ®æœåŠ¡å•†åç§°è¿”å›å¯¹åº”çš„ç±»"""
        service_map = {
            "modelscope": ModelScopeService,
            "deepseek": DeepSeekService,
            "kimi": KimiService
        }
        return service_map.get(provider)
```

**Step 7: Write ai_services/__init__.py**

```python
"""
AIæœåŠ¡æ¨¡å—åˆå§‹åŒ–
"""
from ai_services.base_service import AIService
from ai_services.modelscope_service import ModelScopeService
from ai_services.deepseek_service import DeepSeekService
from ai_services.kimi_service import KimiService
from ai_services.siliconflow_embedder import SiliconFlowEmbedder
from ai_services.service_manager import AIServiceManager

__all__ = [
    'AIService',
    'ModelScopeService',
    'DeepSeekService',
    'KimiService',
    'SiliconFlowEmbedder',
    'AIServiceManager'
]
```

**Step 8: Commit**

```bash
git add ai_services/
git commit -m "feat: implement AI service layer with multiple providers"
```

---

## Task 4: çŸ¥è¯†åº“ç³»ç»Ÿ

### Task 4.1: åˆ›å»ºçŸ¥è¯†åº“ç®¡ç†å™¨

**Files:**
- Create: `knowledge_base/__init__.py`
- Create: `knowledge_base/kb_manager.py`
- Create: `knowledge_base/document_parser.py`

**Step 1: Write knowledge_base/document_parser.py**

```python
"""
æ–‡æ¡£è§£æå™¨ - æ”¯æŒPDFã€EPUBã€Wordã€TXT
"""
from pathlib import Path
from typing import Optional
import os


class DocumentParser:
    """ç»Ÿä¸€æ–‡æ¡£è§£ææ¥å£"""

    def parse(self, file_path: str) -> str:
        """è‡ªåŠ¨è¯†åˆ«æ ¼å¼å¹¶è§£æä¸ºçº¯æ–‡æœ¬

        Args:
            file_path: æ–‡ä»¶è·¯å¾„

        Returns:
            è§£æåçš„æ–‡æœ¬å†…å®¹
        """
        ext = Path(file_path).suffix.lower()

        if ext == '.pdf':
            return self._parse_pdf(file_path)
        elif ext in ['.doc', '.docx']:
            return self._parse_word(file_path)
        elif ext == '.epub':
            return self._parse_epub(file_path)
        elif ext == '.txt':
            return self._parse_txt(file_path)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼: {ext}")

    def _parse_pdf(self, file_path: str) -> str:
        """è§£æPDFæ–‡ä»¶"""
        try:
            from pypdf import PdfReader

            reader = PdfReader(file_path)
            text = ""
            for page in reader.pages:
                text += page.extract_text() + "\n"
            return text

        except ImportError:
            raise ImportError("è¯·å®‰è£…pypdfåº“: pip install pypdf")
        except Exception as e:
            raise Exception(f"PDFè§£æå¤±è´¥: {str(e)}")

    def _parse_word(self, file_path: str) -> str:
        """è§£æWordæ–‡æ¡£"""
        try:
            from docx import Document

            doc = Document(file_path)
            text = ""

            # æå–æ®µè½æ–‡æœ¬
            for para in doc.paragraphs:
                text += para.text + "\n"

            # æå–è¡¨æ ¼æ–‡æœ¬
            for table in doc.tables:
                for row in table.rows:
                    row_data = [cell.text for cell in row.cells]
                    text += " | ".join(row_data) + "\n"

            return text

        except ImportError:
            raise ImportError("è¯·å®‰è£…python-docxåº“: pip install python-docx")
        except Exception as e:
            raise Exception(f"Wordæ–‡æ¡£è§£æå¤±è´¥: {str(e)}")

    def _parse_epub(self, file_path: str) -> str:
        """è§£æEPUBç”µå­ä¹¦"""
        try:
            import ebooklib
            from ebooklib import epub
            from bs4 import BeautifulSoup

            book = epub.read_epub(file_path)
            text = ""

            for item in book.get_items():
                if item.get_type() == ebooklib.ITEM_DOCUMENT:
                    soup = BeautifulSoup(item.get_content(), 'html.parser')
                    text += soup.get_text() + "\n"

            return text

        except ImportError:
            raise ImportError("è¯·å®‰è£…ebooklibå’Œbeautifulsoup4åº“")
        except Exception as e:
            raise Exception(f"EPUBè§£æå¤±è´¥: {str(e)}")

    def _parse_txt(self, file_path: str) -> str:
        """è§£æçº¯æ–‡æœ¬æ–‡ä»¶"""
        try:
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.read()
        except UnicodeDecodeError:
            # å°è¯•å…¶ä»–ç¼–ç 
            try:
                with open(file_path, 'r', encoding='gbk') as f:
                    return f.read()
            except:
                with open(file_path, 'r', encoding='latin-1') as f:
                    return f.read()
```

**Step 2: Write knowledge_base/kb_manager.py**

```python
"""
çŸ¥è¯†åº“ç®¡ç†å™¨ - ä½¿ç”¨ChromaDBå’Œç¡…åŸºæµåŠ¨API
"""
import chromadb
from pathlib import Path
import os
from typing import list, dict
from knowledge_base.document_parser import DocumentParser


class KnowledgeBaseManager:
    """çŸ¥è¯†åº“ç®¡ç†å™¨"""

    def __init__(self, config: dict, embedder):
        """åˆå§‹åŒ–çŸ¥è¯†åº“ç®¡ç†å™¨

        Args:
            config: çŸ¥è¯†åº“é…ç½®
            embedder: ç¡…åŸºæµåŠ¨åµŒå…¥æœåŠ¡å®ä¾‹
        """
        self.embedder = embedder
        self.parser = DocumentParser()
        self.chunk_size = config.get("chunk_size", 800)
        self.chunk_overlap = config.get("chunk_overlap", 100)

        # åˆå§‹åŒ–ChromaDB
        chroma_path = config.get("chroma_path", "./knowledge_base/data")
        Path(chroma_path).mkdir(parents=True, exist_ok=True)

        self.chroma_client = chromadb.PersistentClient(path=chroma_path)
        self.collection = self.chroma_client.get_or_create_collection(
            name="medical_knowledge"
        )

    def add_document(self, file_path: str) -> dict:
        """æ·»åŠ æ–‡æ¡£å¹¶å‘é‡åŒ–

        Args:
            file_path: æ–‡ä»¶è·¯å¾„

        Returns:
            å¤„ç†ç»“æœç»Ÿè®¡
        """
        try:
            filename = os.path.basename(file_path)

            # 1. è§£ææ–‡ä»¶ä¸ºæ–‡æœ¬
            text = self.parser.parse(file_path)
            text_length = len(text)

            # 2. æ–‡æœ¬åˆ†å—
            chunks = self._split_text(text)
            chunk_count = len(chunks)

            # 3. è°ƒç”¨ç¡…åŸºæµåŠ¨APIå‘é‡åŒ–
            embeddings = self.embedder.encode(chunks)
            vector_dim = len(embeddings[0]) if embeddings else 0

            # 4. å­˜å‚¨åˆ°ChromaDB
            ids = [f"{filename}_{i}" for i in range(chunk_count)]
            metadatas = [{
                "source": filename,
                "file_path": file_path
            } for _ in range(chunk_count)]

            self.collection.add(
                documents=chunks,
                embeddings=embeddings,
                metadatas=metadatas,
                ids=ids
            )

            return {
                "success": True,
                "filename": filename,
                "text_length": text_length,
                "chunk_count": chunk_count,
                "vector_dim": vector_dim
            }

        except Exception as e:
            return {
                "success": False,
                "error": str(e)
            }

    def search(self, query: str, top_k: int = 5) -> list[dict]:
        """è¯­ä¹‰æ£€ç´¢

        Args:
            query: æŸ¥è¯¢æ–‡æœ¬
            top_k: è¿”å›ç»“æœæ•°é‡

        Returns:
            æ£€ç´¢ç»“æœåˆ—è¡¨
        """
        try:
            # 1. æŸ¥è¯¢å‘é‡åŒ–
            query_vector = self.embedder.encode([query])[0]

            # 2. ChromaDBæ£€ç´¢
            results = self.collection.query(
                query_embeddings=[query_vector],
                n_results=top_k
            )

            # 3. æ ¼å¼åŒ–ç»“æœ
            formatted_results = []
            for i in range(len(results["ids"][0])):
                formatted_results.append({
                    "text": results["documents"][0][i],
                    "source": results["metadatas"][0][i]["source"],
                    "distance": results["distances"][0][i]
                })

            return formatted_results

        except Exception as e:
            raise Exception(f"æ£€ç´¢å¤±è´¥: {str(e)}")

    def _split_text(self, text: str) -> list[str]:
        """æ™ºèƒ½æ–‡æœ¬åˆ†å—"""
        chunks = []
        start = 0
        text_length = len(text)

        while start < text_length:
            end = start + self.chunk_size

            # å¦‚æœä¸æ˜¯æœ€åä¸€å—ï¼Œå°è¯•åœ¨æ ‡ç‚¹ç¬¦å·å¤„åˆ†å‰²
            if end < text_length:
                for separator in ['ã€‚', 'ï¼', 'ï¼Ÿ', '\n\n', 'ï¼›']:
                    sep_pos = text.rfind(separator, start, end)
                    if sep_pos != -1:
                        end = sep_pos + 1
                        break

            chunk = text[start:end].strip()
            if chunk:
                chunks.append(chunk)

            # ä¸‹ä¸€å—èµ·å§‹ä½ç½®ï¼ˆä¿ç•™é‡å ï¼‰
            start = end - self.chunk_overlap

        return chunks

    def get_stats(self) -> dict:
        """è·å–çŸ¥è¯†åº“ç»Ÿè®¡ä¿¡æ¯"""
        try:
            count = self.collection.count()
            return {
                "total_chunks": count,
                "collection_name": "medical_knowledge"
            }
        except:
            return {
                "total_chunks": 0,
                "collection_name": "medical_knowledge"
            }
```

**Step 3: Write knowledge_base/__init__.py**

```python
"""
çŸ¥è¯†åº“æ¨¡å—åˆå§‹åŒ–
"""
from knowledge_base.kb_manager import KnowledgeBaseManager
from knowledge_base.document_parser import DocumentParser

__all__ = [
    'KnowledgeBaseManager',
    'DocumentParser'
]
```

**Step 4: Commit**

```bash
git add knowledge_base/
git commit -m "feat: implement knowledge base with ChromaDB and SiliconFlow"
```

---

## Task 5: æ ¸å¿ƒä¸šåŠ¡æ¨¡å—

### Task 5.1: æ‚£è€…ç®¡ç†æ¨¡å—

**Files:**
- Create: `modules/__init__.py`
- Create: `modules/patient_manager.py`

**Step 1: Write modules/patient_manager.py**

```python
"""
æ‚£è€…ç®¡ç†æ¨¡å—
"""
from typing import dict, Optional
import json
from datetime import datetime
from database import DBManager
from ai_services import AIServiceManager


class PatientManager:
    """æ‚£è€…ç®¡ç†å™¨"""

    def __init__(self, db_manager: DBManager, ai_manager: AIServiceManager):
        """åˆå§‹åŒ–æ‚£è€…ç®¡ç†å™¨

        Args:
            db_manager: æ•°æ®åº“ç®¡ç†å™¨
            ai_manager: AIæœåŠ¡ç®¡ç†å™¨
        """
        self.db = db_manager
        self.ai = ai_manager

    def create_patient(self, hospital_number: str, initial_note: str) -> dict:
        """åˆ›å»ºæ–°æ‚£è€…

        Args:
            hospital_number: ä½é™¢å·
            initial_note: é¦–æ¬¡ç—…ç¨‹è®°å½•

        Returns:
            åˆ›å»ºç»“æœ
        """
        # æ£€æŸ¥ä½é™¢å·æ˜¯å¦å·²å­˜åœ¨
        existing = self.db.get_patient_by_hospital_number(hospital_number)
        if existing:
            return {
                "success": False,
                "error": "è¯¥ä½é™¢å·å·²å­˜åœ¨"
            }

        # ä½¿ç”¨AIæå–æ‚£è€…ä¿¡æ¯
        try:
            ai_service = self.ai.get_service()
            extracted_info = ai_service.extract_patient_info(initial_note)

            # TODO: è§£æAIè¿”å›çš„JSON

            # æ„å»ºæ‚£è€…æ•°æ®
            patient_data = {
                "hospital_number": hospital_number,
                "name": extracted_info.get("name", ""),
                "gender": extracted_info.get("gender", ""),
                "age": extracted_info.get("age", 0),
                "admission_date": datetime.strptime(
                    extracted_info.get("admission_date"),
                    "%Y-%m-%d"
                ).date() if extracted_info.get("admission_date") else datetime.now().date(),
                "chief_complaint": extracted_info.get("chief_complaint", ""),
                "diagnosis": extracted_info.get("diagnosis", ""),
                "past_history": extracted_info.get("past_history", ""),
                "allergy_history": extracted_info.get("allergy_history", ""),
                "specialist_exam": extracted_info.get("specialist_exam", ""),
                "initial_note": initial_note
            }

            # ä¿å­˜åˆ°æ•°æ®åº“
            patient_id = self.db.add_patient(patient_data)

            # ç”Ÿæˆæé†’
            self._generate_reminders(patient_id, patient_data)

            return {
                "success": True,
                "patient_id": patient_id,
                "extracted_info": extracted_info
            }

        except Exception as e:
            return {
                "success": False,
                "error": f"æ‚£è€…ä¿¡æ¯æå–å¤±è´¥: {str(e)}"
            }

    def _generate_reminders(self, patient_id: int, patient_data: dict):
        """ä¸ºæ–°æ‚£è€…ç”Ÿæˆæé†’"""
        from datetime import timedelta, date

        admission_date = patient_data["admission_date"]

        # ç¬¬2å¤©æé†’ï¼šæŸ¥çœ‹åŒ–éªŒ
        self.db.add_reminder({
            "patient_id": patient_id,
            "hospital_number": patient_data["hospital_number"],
            "reminder_type": "lab_review",
            "reminder_date": admission_date + timedelta(days=2),
            "day_number": 2,
            "description": "è¯·æŸ¥çœ‹åŒ–éªŒæ£€æŸ¥ç»“æœ",
            "priority": "ä¸­"
        })

        # 80å¤©æé†’
        self.db.add_reminder({
            "patient_id": patient_id,
            "hospital_number": patient_data["hospital_number"],
            "reminder_type": "duration_warning",
            "reminder_date": admission_date + timedelta(days=80),
            "day_number": 80,
            "description": "âš ï¸ æ‚£è€…å·²ä½é™¢80å¤©ï¼Œæ³¨æ„90å¤©é™åˆ¶ï¼",
            "priority": "é«˜"
        })

        # 90å¤©æé†’
        self.db.add_reminder({
            "patient_id": patient_id,
            "hospital_number": patient_data["hospital_number"],
            "reminder_type": "duration_warning",
            "reminder_date": admission_date + timedelta(days=90),
            "day_number": 90,
            "description": "ğŸš¨ ä»Šæ—¥å·²è¾¾90å¤©ï¼Œå¿…é¡»å‡†å¤‡å‡ºé™¢æˆ–åŠç†å»¶é•¿æ‰‹ç»­ï¼",
            "priority": "ç´§æ€¥"
        })
```

**Step 2: Commit**

```bash
git add modules/patient_manager.py
git commit -m "feat: implement patient manager with AI extraction"
```

### Task 5.2: ç—…ç¨‹è®°å½•ç”Ÿæˆæ¨¡å—

**Files:**
- Create: `modules/progress_note_generator.py`

**Step 1: Write modules/progress_note_generator.py**

```python
"""
ç—…ç¨‹è®°å½•ç”Ÿæˆæ¨¡å—
"""
from typing import dict, Optional
from datetime import datetime, timedelta
from database import DBManager
from ai_services import AIServiceManager
from knowledge_base import KnowledgeBaseManager


class ProgressNoteGenerator:
    """ç—…ç¨‹è®°å½•ç”Ÿæˆå™¨"""

    def __init__(
        self,
        db_manager: DBManager,
        ai_manager: AIServiceManager,
        kb_manager: Optional[KnowledgeBaseManager] = None
    ):
        """åˆå§‹åŒ–ç—…ç¨‹è®°å½•ç”Ÿæˆå™¨

        Args:
            db_manager: æ•°æ®åº“ç®¡ç†å™¨
            ai_manager: AIæœåŠ¡ç®¡ç†å™¨
            kb_manager: çŸ¥è¯†åº“ç®¡ç†å™¨ï¼ˆå¯é€‰ï¼‰
        """
        self.db = db_manager
        self.ai = ai_manager
        self.kb = kb_manager

    def generate_note(
        self,
        hospital_number: str,
        daily_condition: str,
        record_type: str = "ä½é™¢åŒ»å¸ˆæŸ¥æˆ¿è®°å½•"
    ) -> dict:
        """ç”Ÿæˆç—…ç¨‹è®°å½•

        Args:
            hospital_number: ä½é™¢å·
            daily_condition: å½“æ—¥æƒ…å†µ
            record_type: è®°å½•ç±»å‹

        Returns:
            ç”Ÿæˆç»“æœ
        """
        # è·å–æ‚£è€…ä¿¡æ¯
        patient = self.db.get_patient_by_hospital_number(hospital_number)
        if not patient:
            return {
                "success": False,
                "error": "æ‚£è€…ä¸å­˜åœ¨"
            }

        # è®¡ç®—ä½é™¢å¤©æ•°
        day_number = (datetime.now().date() - patient.admission_date).days + 1

        # è·å–æœ€è¿‘2æ¬¡ç—…ç¨‹è®°å½•
        recent_notes = self.db.get_patient_notes(patient.id, limit=2)

        # æ„å»ºä¸Šä¸‹æ–‡
        context = {
            "name": patient.name,
            "gender": patient.gender,
            "age": patient.age,
            "diagnosis": patient.diagnosis,
            "day_number": day_number,
            "initial_note": patient.initial_note,
            "daily_condition": daily_condition,
            "record_type": record_type,
            "recent_notes_1": recent_notes[0].generated_content if len(recent_notes) > 0 else "",
            "recent_notes_2": recent_notes[1].generated_content if len(recent_notes) > 1 else ""
        }

        # å¦‚æœæœ‰çŸ¥è¯†åº“ï¼Œæ£€ç´¢ç›¸å…³å†…å®¹
        if self.kb:
            try:
                search_query = f"{patient.diagnosis} {daily_condition}"
                kb_results = self.kb.search(search_query, top_k=3)
                knowledge_content = "\n".join([
                    f"ã€æ¥è‡ª {r['source']}ã€‘\n{r['text']}\n"
                    for r in kb_results
                ])
                context["knowledge_base_content"] = knowledge_content
            except:
                context["knowledge_base_content"] = ""

        # è°ƒç”¨AIç”Ÿæˆ
        try:
            ai_service = self.ai.get_service()
            generated_content = ai_service.generate_progress_note(context)

            # ä¿å­˜åˆ°æ•°æ®åº“
            note_data = {
                "patient_id": patient.id,
                "hospital_number": hospital_number,
                "record_date": datetime.now().date(),
                "day_number": day_number,
                "record_type": record_type,
                "daily_condition": daily_condition,
                "generated_content": generated_content,
                "is_edited": False
            }

            note_id = self.db.add_progress_note(note_data)

            return {
                "success": True,
                "note_id": note_id,
                "content": generated_content
            }

        except Exception as e:
            return {
                "success": False,
                "error": f"AIç”Ÿæˆå¤±è´¥: {str(e)}"
            }
```

**Step 2: Commit**

```bash
git add modules/progress_note_generator.py
git commit -m "feat: implement progress note generator with knowledge base integration"
```

### Task 5.3: æé†’ç³»ç»Ÿæ¨¡å—

**Files:**
- Create: `modules/reminder_system.py`

**Step 1: Write modules/reminder_system.py**

```python
"""
æé†’ç³»ç»Ÿæ¨¡å—
"""
from datetime import date, datetime, timedelta
from typing import list
from database import DBManager
from utils.date_calculator import DateCalculator


class ReminderSystem:
    """æé†’ç³»ç»Ÿ"""

    def __init__(self, db_manager: DBManager):
        """åˆå§‹åŒ–æé†’ç³»ç»Ÿ

        Args:
            db_manager: æ•°æ®åº“ç®¡ç†å™¨
        """
        self.db = db_manager
        self.date_calculator = DateCalculator()

    def get_today_reminders(self) -> list[dict]:
        """è·å–ä»Šæ—¥æ‰€æœ‰å¾…å®Œæˆæé†’ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº"""
        reminders = self.db.get_today_reminders()

        # æ ¼å¼åŒ–è¿”å›
        formatted = []
        for r in reminders:
            formatted.append({
                "id": r.id,
                "hospital_number": r.hospital_number,
                "type": r.reminder_type,
                "description": r.description,
                "priority": r.priority,
                "day_number": r.day_number
            })

        return formatted

    def mark_completed(self, reminder_id: int) -> bool:
        """æ ‡è®°æé†’ä¸ºå·²å®Œæˆ"""
        return self.db.mark_reminder_completed(reminder_id)

    def generate_rounds_reminders(self, patient_id: int, admission_date: date, discharge_date: date):
        """ç”ŸæˆæŸ¥æˆ¿è®°å½•æé†’ï¼ˆåŸºäºrounds_generatoré€»è¾‘ï¼‰"""
        records = self.date_calculator.generate_all_reminders(
            admission_date.strftime("%Y-%m-%d"),
            discharge_date.strftime("%Y-%m-%d")
        )

        for record in records:
            # ç¡®å®šä¼˜å…ˆçº§
            if "ä¸»æ²»åŒ»å¸ˆ" in record["type"]:
                priority = "ä¸­"
            elif "ä¸»ä»»åŒ»å¸ˆ" in record["type"]:
                priority = "ä¸­"
            elif "é˜¶æ®µå°ç»“" in record["type"]:
                priority = "é«˜"
            else:
                priority = "ä¸­"

            self.db.add_reminder({
                "patient_id": patient_id,
                "hospital_number": "",  # TODO: ä»patientè·å–
                "reminder_type": "progress_note",
                "reminder_date": datetime.strptime(record["date"], "%Y-%m-%d").date(),
                "day_number": record["day"],
                "description": f"éœ€ä¹¦å†™{record['type']}è®°å½•",
                "priority": priority
            })
```

**Step 2: Commit**

```bash
git add modules/reminder_system.py
git commit -m "feat: implement reminder system with rounds generator integration"
```

---

## Task 6: GUIç•Œé¢å±‚

### Task 6.1: åˆ›å»ºä¸»çª—å£

**Files:**
- Create: `ui/__init__.py`
- Create: `ui/main_window.py`
- Create: `ui/styles.py`

**Step 1: Write ui/styles.py**

```python
"""
UIæ ·å¼é…ç½® - iOSé£æ ¼
"""
import customtkinter as ctk

# é…ç½®CustomTkinter
ctk.set_appearance_mode("Light")
ctk.set_default_color_theme("blue")

# é¢œè‰²å®šä¹‰
class Colors:
    PRIMARY = "#007AFF"
    SUCCESS = "#34C759"
    WARNING = "#FF9500"
    DANGER = "#FF3B30"
    BACKGROUND = "#F2F2F7"
    CARD = "#FFFFFF"

# å­—ä½“é…ç½®
class Fonts:
    TITLE_LARGE = ctk.CTkFont(size=24, weight="bold")
    TITLE_MEDIUM = ctk.CTkFont(size=18, weight="bold")
    BODY = ctk.CTkFont(size=14)
    SMALL = ctk.CTkFont(size=12)
```

**Step 2: Write ui/main_window.py**

```python
"""
ä¸»çª—å£ - iOSé£æ ¼
"""
import customtkinter as ctk
from ui.styles import Colors, Fonts


class MainWindow(ctk.CTk):
    """ä¸»çª—å£ç±»"""

    def __init__(self, db_manager, ai_manager, kb_manager):
        super().__init__()

        self.db = db_manager
        self.ai = ai_manager
        self.kb = kb_manager
        self.current_patient = None

        # é…ç½®çª—å£
        self.title("åº·å¤ç§‘åŠ©æ‰‹")
        self.geometry("1400x900")

        # é…ç½®ç½‘æ ¼å¸ƒå±€
        self.grid_columnconfigure(1, weight=1)
        self.grid_rowconfigure(0, weight=1)

        # åˆ›å»ºç•Œé¢
        self._create_navbar()
        self._create_sidebar()
        self._create_workspace()
        self._create_quick_tools()

    def _create_navbar(self):
        """åˆ›å»ºé¡¶éƒ¨å¯¼èˆªæ """
        navbar = ctk.CTkFrame(self, height=60, fg_color="transparent")
        navbar.grid(row=0, column=0, columnspan=3, sticky="nsew", padx=10, pady=10)

        # å·¦ä¾§ï¼šåº”ç”¨å›¾æ ‡å’Œæ ‡é¢˜
        left_frame = ctk.CTkFrame(navbar, fg_color="transparent")
        left_frame.pack(side="left", padx=10)

        ctk.CTkLabel(left_frame, text="ğŸ¥", font=ctk.CTkFont(size=24)).pack(side="left")
        ctk.CTkLabel(left_frame, text="åº·å¤ç§‘åŠ©æ‰‹", font=Fonts.TITLE_MEDIUM).pack(side="left", padx=10)

        # ä¸­é—´ï¼šæ—¥æœŸ
        center_frame = ctk.CTkFrame(navbar, fg_color="transparent")
        center_frame.pack(side="left", expand=True)
        # TODO: æ·»åŠ æ—¥æœŸæ˜¾ç¤º

        # å³ä¾§ï¼šæŒ‰é’®
        right_frame = ctk.CTkFrame(navbar, fg_color="transparent")
        right_frame.pack(side="right", padx=10)

        # æé†’æŒ‰é’®
        self.reminder_btn = ctk.CTkButton(
            right_frame,
            text="ğŸ”” 5",
            width=50,
            fg_color="transparent",
            border_width=2
        )
        self.reminder_btn.pack(side="left", padx=5)

        # æ–°æ‚£è€…æŒ‰é’®
        new_patient_btn = ctk.CTkButton(
            right_frame,
            text="â• æ–°æ‚£è€…",
            fg_color=Colors.PRIMARY
        )
        new_patient_btn.pack(side="left", padx=5)

        # è®¾ç½®æŒ‰é’®
        settings_btn = ctk.CTkButton(
            right_frame,
            text="âš™ï¸",
            width=50,
            fg_color="transparent"
        )
        settings_btn.pack(side="left", padx=5)

    def _create_sidebar(self):
        """åˆ›å»ºå·¦ä¾§æ‚£è€…åˆ—è¡¨"""
        sidebar = ctk.CTkFrame(self, width=280, corner_radius=12)
        sidebar.grid(row=1, column=0, sticky="nsew", padx=10, pady=10)

        # æ ‡é¢˜
        header = ctk.CTkFrame(sidebar, fg_color="transparent")
        header.pack(fill="x", padx=15, pady=15)

        ctk.CTkLabel(header, text="ä»Šæ—¥å¾…åŠ", font=Fonts.TITLE_MEDIUM).pack(side="left")
        ctk.CTkLabel(header, text="12", font=Fonts.BOLD, text_color=Colors.PRIMARY).pack(side="right")

        # æ‚£è€…åˆ—è¡¨
        self.patient_list_frame = ctk.CTkScrollableFrame(sidebar, label_text="")
        self.patient_list_frame.pack(fill="both", expand=True, padx=10, pady=10)

        # TODO: åŠ è½½æ‚£è€…åˆ—è¡¨

    def _create_workspace(self):
        """åˆ›å»ºä¸­é—´å·¥ä½œåŒº"""
        workspace = ctk.CTkScrollableFrame(self, corner_radius=12)
        workspace.grid(row=1, column=1, sticky="nsew", padx=10, pady=10)

        # æ‚£è€…ä¿¡æ¯å¡ç‰‡
        info_frame = ctk.CTkFrame(workspace)
        info_frame.pack(fill="x", padx=15, pady=15)

        ctk.CTkLabel(info_frame, text="æ‚£è€…ä¿¡æ¯", font=Fonts.TITLE_MEDIUM).pack(anchor="w", padx=15, pady=10)

        # TODO: æ·»åŠ æ‚£è€…è¯¦ç»†ä¿¡æ¯

        # ç—…ç¨‹è®°å½•ç”Ÿæˆå¡ç‰‡
        note_frame = ctk.CTkFrame(workspace)
        note_frame.pack(fill="both", expand=True, padx=15, pady=15)

        ctk.CTkLabel(note_frame, text="ç—…ç¨‹è®°å½•ç”Ÿæˆ", font=Fonts.TITLE_MEDIUM).pack(anchor="w", padx=15, pady=10)

        # å½“æ—¥æƒ…å†µè¾“å…¥
        ctk.CTkLabel(note_frame, text="å½“æ—¥æƒ…å†µï¼š", font=Fonts.BODY).pack(anchor="w", padx=15)

        self.daily_condition_text = ctk.CTkTextbox(note_frame, height=100)
        self.daily_condition_text.pack(fill="x", padx=15, pady=5)

        # æ“ä½œæŒ‰é’®
        btn_frame = ctk.CTkFrame(note_frame, fg_color="transparent")
        btn_frame.pack(fill="x", padx=15, pady=10)

        ctk.CTkButton(
            btn_frame,
            text="âœ¨ AIç”Ÿæˆ",
            fg_color=Colors.PRIMARY,
            command=self._on_generate_note
        ).pack(side="left", expand=True, fill="x", padx=5)

        ctk.CTkButton(
            btn_frame,
            text="ğŸ’¾ ä¿å­˜",
            command=self._on_save_note
        ).pack(side="left", expand=True, fill="x", padx=5)

        ctk.CTkButton(
            btn_frame,
            text="ğŸ“„ å¯¼å‡ºtxt",
            command=self._on_export_note
        ).pack(side="left", expand=True, fill="x", padx=5)

        # é¢„è§ˆåŒºåŸŸ
        ctk.CTkLabel(note_frame, text="AIç”Ÿæˆé¢„è§ˆï¼š", font=Fonts.BODY).pack(anchor="w", padx=15)

        self.preview_text = ctk.CTkTextbox(note_frame, height=200)
        self.preview_text.pack(fill="both", expand=True, padx=15, pady=5)

    def _create_quick_tools(self):
        """åˆ›å»ºå³ä¾§å¿«é€Ÿå·¥å…·"""
        tools = ctk.CTkFrame(self, width=300, corner_radius=12)
        tools.grid(row=1, column=2, sticky="nsew", padx=10, pady=10)

        ctk.CTkLabel(tools, text="å¿«é€Ÿæ¨¡æ¿", font=Fonts.TITLE_MEDIUM).pack(anchor="w", padx=15, pady=15)

        # æ¨¡æ¿é€‰æ‹©å™¨
        # TODO: æ·»åŠ æ¨¡æ¿ä¸‹æ‹‰æ¡†

        # å¸¸ç”¨çŸ­è¯­
        ctk.CTkLabel(tools, text="å¸¸ç”¨çŸ­è¯­", font=Fonts.BODY).pack(anchor="w", padx=15, pady=(10, 5))

        phrases_frame = ctk.CTkFrame(tools, fg_color="transparent")
        phrases_frame.pack(fill="x", padx=15)

        phrases = ["æ‚£è€…ç¥å¿—æ¸…ï¼Œç²¾ç¥å¯", "ç»§ç»­åº·å¤è®­ç»ƒ", "å®¶å±é…åˆ", "æŸ¥ä½“åŒå‰"]
        for phrase in phrases:
            btn = ctk.CTkButton(
                phrases_frame,
                text=phrase,
                fg_color="transparent",
                border_width=1,
                anchor="w"
            )
            btn.pack(fill="x", pady=2)

    def _on_generate_note(self):
        """ç”Ÿæˆç—…ç¨‹è®°å½•"""
        if not self.current_patient:
            ctk.CTkMessageBox(
                title="æç¤º",
                message="è¯·å…ˆé€‰æ‹©æ‚£è€…",
                icon="warning"
            )
            return

        daily_condition = self.daily_condition_text.get("1.0", "end").strip()
        if not daily_condition:
            ctk.CTkMessageBox(
                title="æç¤º",
                message="è¯·è¾“å…¥å½“æ—¥æƒ…å†µ",
                icon="warning"
            )
            return

        # TODO: è°ƒç”¨ç”Ÿæˆæ¨¡å—
        self.preview_text.delete("1.0", "end")
        self.preview_text.insert("1.0", "æ­£åœ¨ç”Ÿæˆ...")

    def _on_save_note(self):
        """ä¿å­˜ç—…ç¨‹è®°å½•"""
        # TODO: å®ç°ä¿å­˜åŠŸèƒ½
        pass

    def _on_export_note(self):
        """å¯¼å‡ºç—…ç¨‹è®°å½•"""
        # TODO: å®ç°å¯¼å‡ºåŠŸèƒ½
        pass
```

**Step 3: Write ui/__init__.py**

```python
"""
UIæ¨¡å—åˆå§‹åŒ–
"""
from ui.main_window import MainWindow
from ui.styles import Colors, Fonts

__all__ = ['MainWindow', 'Colors', 'Fonts']
```

**Step 4: Commit**

```bash
git add ui/
git commit -m "feat: implement main window with iOS-style CustomTkinter GUI"
```

---

## Task 7: é›†æˆæµ‹è¯•

### Task 7.1: æ›´æ–°main.py

**Files:**
- Modify: `main.py`

**Step 1: Update main.py**

```python
"""
åº·å¤ç§‘åŠ©æ‰‹ - ä¸»å…¥å£
"""
import customtkinter as ctk
import json
from pathlib import Path

from database import DBManager
from ai_services import AIServiceManager
from knowledge_base import KnowledgeBaseManager
from ui import MainWindow


def load_config(config_path: str = "config.json") -> dict:
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    with open(config_path, 'r', encoding='utf-8') as f:
        return json.load(f)


def main():
    # é…ç½®CustomTkinter
    ctk.set_appearance_mode("Light")
    ctk.set_default_color_theme("blue")

    # åŠ è½½é…ç½®
    config = load_config()

    # åˆå§‹åŒ–æ•°æ®åº“
    print("åˆå§‹åŒ–æ•°æ®åº“...")
    db_manager = DBManager(config["app"]["database_path"])

    # åˆå§‹åŒ–AIæœåŠ¡
    print("åˆå§‹åŒ–AIæœåŠ¡...")
    ai_manager = AIServiceManager(config)

    # åˆå§‹åŒ–çŸ¥è¯†åº“
    kb_manager = None
    if ai_manager.get_embedder():
        print("åˆå§‹åŒ–çŸ¥è¯†åº“...")
        kb_manager = KnowledgeBaseManager(
            config["knowledge_base"],
            ai_manager.get_embedder()
        )

    # åˆ›å»ºå¹¶è¿è¡Œä¸»çª—å£
    print("å¯åŠ¨åº”ç”¨...")
    app = MainWindow(db_manager, ai_manager, kb_manager)
    app.mainloop()


if __name__ == "__main__":
    main()
```

**Step 2: Commit**

```bash
git add main.py
git commit -m "feat: integrate all modules in main entry point"
```

### Task 7.2: åˆ›å»ºæµ‹è¯•è„šæœ¬

**Files:**
- Create: `tests/__init__.py`
- Create: `tests/test_database.py`
- Create: `tests/test_ai_services.py`
- Create: `tests/test_integration.py`

**Step 1: Write tests/test_database.py**

```python
"""
æ•°æ®åº“æµ‹è¯•
"""
import pytest
import tempfile
import os
from database import DBManager, Patient


def test_add_patient(db_manager):
    """æµ‹è¯•æ·»åŠ æ‚£è€…"""
    patient_data = {
        "hospital_number": "TEST001",
        "name": "æµ‹è¯•æ‚£è€…",
        "gender": "ç”·",
        "age": 65,
        "admission_date": "2025-01-23",
        "diagnosis": "è„‘æ¢—æ­»æ¢å¤æœŸ",
        "initial_note": "æ‚£è€…å› å³ä¾§è‚¢ä½“æ´»åŠ¨ä¸åˆ©10å¤©å…¥é™¢..."
    }

    patient_id = db_manager.add_patient(patient_data)
    assert patient_id is not None

    # éªŒè¯æ‚£è€…å·²æ·»åŠ 
    patient = db_manager.get_patient_by_hospital_number("TEST001")
    assert patient is not None
    assert patient.name == "æµ‹è¯•æ‚£è€…"


@pytest.fixture
def db_manager():
    """æ•°æ®åº“ç®¡ç†å™¨fixture"""
    # ä½¿ç”¨ä¸´æ—¶æ•°æ®åº“
    temp_db = tempfile.NamedTemporaryFile(delete=False, suffix=".db")
    temp_db.close()

    db = DBManager(temp_db.name)

    yield db

    # æ¸…ç†
    os.unlink(temp_db.name)
```

**Step 2: Write tests/test_ai_services.py**

```python
"""
AIæœåŠ¡æµ‹è¯•
"""
import pytest
from ai_services import AIServiceManager


def test_service_manager_initialization():
    """æµ‹è¯•AIæœåŠ¡ç®¡ç†å™¨åˆå§‹åŒ–"""
    config = {
        "siliconflow": {
            "api_key": "test_key"
        },
        "ai_services": {
            "default": "modelscope",
            "modelscope": {
                "api_key": "",
                "model": "Qwen2.5-72B-Instruct"
            }
        }
    }

    manager = AIServiceManager(config)
    assert manager is not None
    assert manager.get_embedder() is not None
```

**Step 3: Write tests/test_integration.py**

```python
"""
é›†æˆæµ‹è¯•
"""
import pytest
from modules import PatientManager, ProgressNoteGenerator
from database import DBManager
from ai_services import AIServiceManager


def test_create_patient_workflow(db_manager, ai_manager):
    """æµ‹è¯•åˆ›å»ºæ‚£è€…å®Œæ•´æµç¨‹"""
    patient_mgr = PatientManager(db_manager, ai_manager)

    # æ³¨æ„ï¼šæ­¤æµ‹è¯•éœ€è¦çœŸå®APIå¯†é’¥
    result = patient_mgr.create_patient(
        hospital_number="TEST001",
        initial_note="æ‚£è€…å¼ ä¸‰ï¼Œç”·ï¼Œ65å²ï¼Œå› å³ä¾§è‚¢ä½“æ´»åŠ¨ä¸åˆ©10å¤©å…¥é™¢..."
    )

    # ç”±äºæ²¡æœ‰çœŸå®APIï¼Œè¿™é‡Œåªæµ‹è¯•ç»“æ„
    assert "success" in result


@pytest.fixture
def ai_manager():
    """AIç®¡ç†å™¨fixture"""
    config = {
        "siliconflow": {
            "api_key": "test_key"
        },
        "ai_services": {
            "default": "modelscope",
            "modelscope": {
                "api_key": "test_key",
                "model": "Qwen2.5-72B-Instruct"
            }
        }
    }

    return AIServiceManager(config)
```

**Step 4: Commit**

```bash
git add tests/
git commit -m "test: add integration and unit tests"
```

---

## Task 8: æ–‡æ¡£å’Œéƒ¨ç½²

### Task 8.1: åˆ›å»ºç”¨æˆ·æ–‡æ¡£

**Files:**
- Create: `docs/USER_GUIDE.md`
- Create: `docs/API.md`
- Update: `README.md`

**Step 1: Write docs/USER_GUIDE.md**

```markdown
# åº·å¤ç§‘åŠ©æ‰‹ - ç”¨æˆ·æŒ‡å—

## å®‰è£…

### 1. Pythonç¯å¢ƒå‡†å¤‡
```bash
python --version  # ç¡®ä¿ Python 3.10+
```

### 2. å®‰è£…ä¾èµ–
```bash
pip install -r requirements.txt
```

### 3. é…ç½®APIå¯†é’¥

ç¼–è¾‘ `config.json` æˆ–åˆ›å»º `.env` æ–‡ä»¶ï¼š
```env
MODELSCOPE_API_KEY=your_api_key
DEEPSEEK_API_KEY=your_api_key
KIMI_API_KEY=your_api_key
```

## ä½¿ç”¨

### å¯åŠ¨åº”ç”¨
```bash
python main.py
```

### åˆ›å»ºæ‚£è€…
1. ç‚¹å‡»"â•æ–°æ‚£è€…"æŒ‰é’®
2. è¾“å…¥ä½é™¢å·
3. ç²˜è´´é¦–æ¬¡ç—…ç¨‹è®°å½•
4. ç¡®è®¤æå–çš„ä¿¡æ¯
5. ä¿å­˜

### ç”Ÿæˆç—…ç¨‹è®°å½•
1. ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©æ‚£è€…
2. è¾“å…¥å½“æ—¥æƒ…å†µ
3. ç‚¹å‡»"âœ¨ AIç”Ÿæˆ"
4. æŸ¥çœ‹å¹¶ç¼–è¾‘ç”Ÿæˆçš„è®°å½•
5. ä¿å­˜æˆ–å¯¼å‡º

## å¿«æ·é”®
- `Ctrl+N`: åˆ›å»ºæ–°æ‚£è€…
- `Ctrl+S`: ä¿å­˜
- `Ctrl+Enter`: AIç”Ÿæˆ
```

**Step 2: Commit**

```bash
git add docs/
git commit -m "docs: add user guide and API documentation"
```

---

## æ€»ç»“

æœ¬è®¡åˆ’æä¾›äº†åº·å¤ç§‘åŠ©æ‰‹çš„å®Œæ•´å®æ–½è·¯å¾„ï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **é¡¹ç›®åˆå§‹åŒ–** - ä¾èµ–ç®¡ç†å’Œé…ç½®
2. âœ… **æ•°æ®åº“å±‚** - SQLAlchemy ORMå’Œ8ä¸ªæ ¸å¿ƒè¡¨
3. âœ… **AIæœåŠ¡å±‚** - å¤šæœåŠ¡å•†æŠ½è±¡å±‚ï¼ˆé­”æ­/DeepSeek/Kimiï¼‰
4. âœ… **çŸ¥è¯†åº“ç³»ç»Ÿ** - ChromaDB + ç¡…åŸºæµåŠ¨å‘é‡åŒ–
5. âœ… **æ ¸å¿ƒä¸šåŠ¡æ¨¡å—** - æ‚£è€…ç®¡ç†ã€ç—…ç¨‹ç”Ÿæˆã€æé†’ç³»ç»Ÿ
6. âœ… **GUIç•Œé¢å±‚** - CustomTkinter iOSé£æ ¼ç•Œé¢
7. âœ… **é›†æˆæµ‹è¯•** - å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
8. âœ… **æ–‡æ¡£éƒ¨ç½²** - ç”¨æˆ·æŒ‡å—å’ŒAPIæ–‡æ¡£

### æŠ€æœ¯æ ˆæ€»è§ˆ

| å±‚çº§ | æŠ€æœ¯ | ç”¨é€” |
|------|------|------|
| GUI | CustomTkinter | iOSé£æ ¼æ¡Œé¢ç•Œé¢ |
| æ•°æ®åº“ | SQLAlchemy + SQLite | ORMå’Œæœ¬åœ°å­˜å‚¨ |
| å‘é‡æ•°æ®åº“ | ChromaDB | çŸ¥è¯†åº“è¯­ä¹‰æ£€ç´¢ |
| AIæœåŠ¡ | ModelScope/DeepSeek/Kimi | ç—…ç¨‹è®°å½•ç”Ÿæˆ |
| åµŒå…¥æœåŠ¡ | ç¡…åŸºæµåŠ¨API | æ–‡æœ¬å‘é‡åŒ– |
| æ–‡æ¡£è§£æ | PyPDF/python-docx/ebooklib | å¤šæ ¼å¼æ–‡æ¡£æ”¯æŒ |

### é¢„è®¡å¼€å‘æ—¶é—´

- Task 1-2: é¡¹ç›®åˆå§‹åŒ–å’Œæ•°æ®åº“ - 1å¤©
- Task 3: AIæœåŠ¡å±‚ - 2å¤©
- Task 4: çŸ¥è¯†åº“ç³»ç»Ÿ - 2å¤©
- Task 5: æ ¸å¿ƒä¸šåŠ¡æ¨¡å— - 3å¤©
- Task 6: GUIç•Œé¢ - 4å¤©
- Task 7-8: æµ‹è¯•å’Œæ–‡æ¡£ - 2å¤©

**æ€»è®¡ï¼šçº¦14ä¸ªå·¥ä½œæ—¥**

---

**Plan complete and saved to `docs/plans/2025-01-23-åº·å¤ç§‘åŠ©æ‰‹å®Œæ•´å®æ–½è®¡åˆ’.md`. Two execution options:**

**1. Subagent-Driven (this session)** - I dispatch fresh subagent per task, review between tasks, fast iteration

**2. Parallel Session (separate)** - Open new session with executing-plans, batch execution with checkpoints

**Which approach?**
